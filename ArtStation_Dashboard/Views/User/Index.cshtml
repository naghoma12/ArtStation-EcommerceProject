@using ArtStation_Dashboard.ViewModels.User
@model PagedResult<UserViewModel>

@{
    var culture = System.Globalization.CultureInfo.CurrentUICulture;
    var dir = culture.TextInfo.IsRightToLeft ? "rtl" : "ltr";
    var lang = culture.Name;
}

@if (TempData["SuccessMessage"] != null)
{
    <div class="alert alert-primary alert-dismissible text-white fade show" role="alert">
        <span class="alert-icon align-middle">
            <span class="material-symbols-rounded text-md"></span>
        </span>
        <span class="alert-text"><strong>@TempData["SuccessMessage"]!</strong></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close">
            <span aria-hidden="true">&times;</span>
        </button>
    </div>
}
<div class="d-flex justify-content-center my-3">
    <a href="#" class="btn btn-outline-primary mx-1 ajax-filter @(ViewBag.StatusFilter == null ? "active" : "")"
       data-status="">
        @(("الكل", "All").Localize(lang))
    </a>
    <a href="#" class="btn btn-outline-info mx-1 ajax-filter @(ViewBag.StatusFilter?.ToString() == "True" ? "active" : "")"
       data-status="true">
        @(("مفعل", "Active").Localize(lang))
    </a>
    <a href="#" class="btn btn-outline-danger mx-1 ajax-filter @(ViewBag.StatusFilter?.ToString() == "False" ? "active" : "")"
       data-status="false">
        @(("غير مفعل", "NonActive").Localize(lang))
    </a>
</div>

<div class="container-fluid py-4">
    <form style="display:none;">
        @Html.AntiForgeryToken()
    </form>

    <div class="row">
        <div class="col-12">
            <div class="card my-4">
                <div class="card-header p-0 position-relative mt-n4 mx-3 z-index-2">
                    <div class="bg-gradient-primary shadow-primary border-radius-lg pt-4 pb-3">
                        <h6 class="text-white text-capitalize ps-3 pe-3">@(("حسابات العملاء", "Customer Accounts").Localize(lang))</h6>
                    </div>
                </div>
                <div class="card-body px-0 pb-2">
                    <div class="table-responsive p-0">
                        @Html.Partial("_UserTablePartial", Model)
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<nav aria-label="Page navigation">
    <ul class="pagination pagination-primary pagination-sm justify-content-center">
        @for (int i = 1; i <= ViewBag.TotalPages; i++)
        {
            var isActive = (i == ViewBag.CurrentPage) ? "active" : "";
            <li class="page-item @isActive">
                <a class="page-link" href="?page=@i">@i</a>
            </li>
        }
    </ul>
</nav>

@section Scripts {
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>


    <script>
         let currentStatus = '@ViewBag.StatusFilter'.toLowerCase();
        let pageSize = '@Model.PageSize';
                function loadBanners(page, status) {
            $.ajax({
                url: '@Url.Action("Index", "User")',
                type: 'GET',
                data: {
                    page: page,
                    pageSize: pageSize,
                    statusFilter: status === "" ? null : status
                },
                success: function (data) {
                    $("#banner-table-container").html(data);
                    currentStatus = status;
                },
                error: function (xhr) {
                    console.error("Error loading banners:", xhr);
                }
            });
        }


        // Handle filter buttons
        $(document).on("click", ".ajax-filter", function (e) {
            e.preventDefault();
            let status = $(this).data("status")?.toString().toLowerCase() || "";
            $(".ajax-filter").removeClass("active");
            $(this).addClass("active");
            loadBanners(1, status);
        });

        // Handle pagination
        $(document).on("click", ".ajax-page", function (e) {
            e.preventDefault();
            let page = $(this).data("page");
            loadBanners(page, currentStatus);
        });



       
         $(document).on("change", ".toggle-active", function () {


            var checkbox = $(this);
            var id = checkbox.data("id");
            var isActive = checkbox.is(":checked");

            $.ajax({
                url: '/User/ToggleActive',
                type: 'POST',
                headers: {
                    'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
                },
                data: {
                    id: id,
                    isActive: isActive
                },
                success: function () {
                    var label = checkbox.closest('.form-check').find('label');
                    label.text(isActive ? "مفعل" : "غير مفعل");
                },
                error: function () {
                    alert("حدث خطأ أثناء تحديث حالة التفعيل.");
                    checkbox.prop("checked", !isActive);
                }
            });
        });

        $(document).on("click", ".delete-user-btn", function () {
            const userId = $(this).data("user-id");
            const userName = $(this).data("user-name");
            const rowId = $(this).data("row-id");

            Swal.fire({
                title: "هل أنت متأكد؟",
                text: `هل تريد حذف المستخدم: ${userName}؟`,
                icon: "warning",
                showCancelButton: true,
                confirmButtonText: "نعم، احذف",
                cancelButtonText: "إلغاء",
                confirmButtonColor: "#d33",
                cancelButtonColor: "#3085d6"
            }).then((result) => {
                if (result.isConfirmed) {
                    const token = $('input[name="__RequestVerificationToken"]').val();

                    $.ajax({
                        url: '/User/DeleteAjax',
                        type: 'POST',
                        headers: {
                            'RequestVerificationToken': token
                        },
                        data: { id: userId },
                        success: function (response) {
                            if (response.success) {
                                $("#" + rowId).remove();
                                Swal.fire("تم الحذف!", "تم حذف المستخدم بنجاح.", "success");
                            } else {
                                Swal.fire("خطأ", response.message || "فشل في حذف المستخدم.", "error");
                            }
                        },
                        error: function () {
                            Swal.fire("خطأ", "حدث خطأ أثناء تنفيذ العملية.", "error");
                        }
                    });
                }
            });
        });
    </script>
}
